<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race History - Pixel Ponies</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Race History - Pixel Ponies">
    <meta property="og:description" content="View all Pixel Ponies races on Base blockchain">
    <meta property="og:image" content="/favicon.ico">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Race History - Pixel Ponies">
    <meta name="twitter:description" content="View all Pixel Ponies races on Base blockchain">
    <meta name="twitter:image" content="/favicon.ico">

    <style>
        /* Retro pixel overrides */
        * {
            font-family: 'Press Start 2P', monospace !important;
        }
        body {
            background: #bdc3ff !important;
            font-size: 8px !important;
            padding: 8px !important;
        }
        button {
            background: #ff6b6b !important;
            border: 2px solid #d32f2f !important;
            border-radius: 0 !important;
            font-size: 8px !important;
            box-shadow: none !important;
            padding: 8px 12px !important;
            cursor: pointer;
        }
        button:hover {
            background: #f55555 !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .stat-card {
            background: #ffffff;
            border: 2px solid #cccccc;
            padding: 20px;
            text-align: center;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .stat-value {
            font-size: 20px;
            color: #000000;
            margin: 10px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .stat-label {
            font-size: 8px;
            color: #000000;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .race-list {
            margin: 20px 0;
        }

        .race-item {
            background: #ffffff;
            border: 2px solid #cccccc;
            padding: 16px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .race-item:hover {
            transform: translateX(4px);
            border-color: #ff6b6b;
        }

        .race-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }

        .race-id {
            font-size: 12px;
            color: #ff6b6b;
        }

        .race-status {
            padding: 4px 8px;
            border: 2px solid;
            font-size: 8px;
        }

        .race-status.won {
            color: #22c55e;
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .race-status.lost {
            color: #ef4444;
            border-color: #ef4444;
            background: #fef2f2;
        }

        .race-details {
            font-size: 8px;
            color: #666;
            line-height: 1.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .load-more {
            text-align: center;
            margin: 20px 0;
        }

        /* Race Track Styles */
        .track-container {
            background: linear-gradient(to bottom, #1a202c 0%, #2d3748 100%);
            border: 3px solid #4a5568;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 400px;
            margin: 20px 0;
        }

        .track-lane {
            background: linear-gradient(90deg, #2d3748 0%, #4a5568 50%, #2d3748 100%);
            height: 20px;
            margin: 4px 0;
            border-radius: 5px;
            position: relative;
            border: 1px solid #718096;
            display: flex;
            align-items: center;
        }

        .lane-number {
            position: absolute;
            left: 5px;
            color: #fff;
            font-size: 8px;
            z-index: 1;
        }

        .horse-racer {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.1s linear;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .horse-racer.winner {
            animation: winner-pulse 0.5s ease-in-out infinite;
        }

        .horse-racer.player-horse {
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        @keyframes winner-pulse {
            0%, 100% {
                transform: translateY(-50%) scale(1);
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)) brightness(1);
            }
            50% {
                transform: translateY(-50%) scale(1.3);
                filter: drop-shadow(0 0 12px rgba(255, 215, 0, 1)) brightness(1.2);
            }
        }

        .finish-line {
            position: absolute;
            right: 30px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                45deg,
                #fff,
                #fff 10px,
                #000 10px,
                #000 20px
            );
        }

        .start-line {
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                45deg,
                #4ade80,
                #4ade80 10px,
                #22c55e 10px,
                #22c55e 20px
            );
        }

        .race-item {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="/">
                <img src="logo.png" alt="Pixel Ponies Logo" style="height: 48px; margin-bottom: 8px;">
            </a>
            <h1>RACE HISTORY</h1>
            <p>ALL RACES ON BASE BLOCKCHAIN</p>
        </header>

        <main>
            <!-- Loading State -->
            <div id="loadingSection" class="loading">
                <p>Loading race history from Base blockchain...</p>
                <p style="font-size: 7px; color: #999; margin-top: 8px;">Querying last 100,000 blocks (recent races)</p>
            </div>

            <!-- Statistics -->
            <section id="statsSection" style="display: none; color: #000000;">
                <h2 style="color: #000000;">üìä Race Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label" style="color: #000000;">TOTAL RACES</div>
                        <div class="stat-value" id="totalRaces">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color: #000000;">UNIQUE PLAYERS</div>
                        <div class="stat-value" id="totalPlayers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color: #000000;">JACKPOT</div>
                        <div class="stat-value" id="totalPrizes">0</div>
                        <div class="stat-label" style="color: #000000;">PONY</div>
                    </div>
                </div>
            </section>

            <!-- Race Animation Viewer -->
            <section id="animationSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 id="animationTitle">üèÅ Race Animation</h2>
                    <button onclick="backToList()" style="font-size: 8px;">‚¨ÖÔ∏è Back to List</button>
                </div>
                <div class="track-container" id="trackContainer">
                    <div class="start-line"></div>
                    <div class="finish-line"></div>
                    <div id="raceLanes"></div>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button onclick="replayAnimation()">üîÑ Replay Race</button>
                    <button onclick="shareOnTwitter()" style="margin-left: 12px;">üê¶ Share on Twitter</button>
                </div>
            </section>

            <!-- Race List -->
            <section id="raceListSection" style="display: none;">
                <h2>üèÅ Recent Races</h2>
                <div id="raceList" class="race-list">
                    <!-- Races will be populated here -->
                </div>
                <div class="load-more" id="loadMoreSection" style="display: none;">
                    <button onclick="loadMoreRaces()">Load More Races</button>
                </div>
            </section>

            <!-- Back Button -->
            <section style="text-align: center; padding: 24px;">
                <a href="/game">
                    <button style="font-size: 12px; padding: 16px 32px;">
                        üéÆ PLAY NOW üéÆ
                    </button>
                </a>
            </section>
        </main>

        <!-- Footer -->
        <footer style="background: #ffffff; border: 2px solid #cccccc; margin-top: 24px; padding: 16px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; margin-bottom: 12px;">
                <a href="/" style="color: #000000; text-decoration: none; font-size: 8px;">üè† HOME</a>
                <a href="/game" style="color: #ff6b6b; text-decoration: none; font-size: 8px;">üéÆ PLAY NOW</a>
                <a href="/buy" style="color: #000000; text-decoration: none; font-size: 8px;">üí∞ BUY $PONY</a>
                <a href="/whitepaper" style="color: #000000; text-decoration: none; font-size: 8px;">üìÑ WHITEPAPER</a>
                <a href="/terms" style="color: #000000; text-decoration: none; font-size: 8px;">‚öñÔ∏è TERMS</a>
                <a href="/privacy" style="color: #000000; text-decoration: none; font-size: 8px;">üîí PRIVACY</a>
            </div>
            <p style="font-size: 6px; color: #666666; line-height: 1.6;">
                Pixel Ponies ¬© 2025 | 16 Pixelated Ponies Racing On-Chain For No Reason<br>
                Built on Base Network | Not financial advice | Play responsibly
            </p>
        </footer>
    </div>

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // Format large numbers with proper suffixes
        function formatPonyAmount(num) {
            // Convert to number if it's a string
            const absNum = Math.abs(parseFloat(num));

            // For trillions (1,000,000,000,000+)
            if (absNum >= 1e12) {
                const value = absNum / 1e12;
                return value.toFixed(value >= 10 ? 1 : 2) + 'T';
            }
            // For billions (1,000,000,000+)
            else if (absNum >= 1e9) {
                const value = absNum / 1e9;
                return value.toFixed(value >= 10 ? 1 : 2) + 'B';
            }
            // For millions (1,000,000+)
            else if (absNum >= 1e6) {
                const value = absNum / 1e6;
                return value.toFixed(value >= 10 ? 1 : 2) + 'M';
            }
            // For thousands (1,000+)
            else if (absNum >= 1e3) {
                const value = absNum / 1e3;
                return value.toFixed(value >= 10 ? 1 : 2) + 'K';
            }
            // For smaller amounts
            else {
                return absNum.toFixed(2);
            }
        }

        // Contract Addresses on Base Mainnet
        const PIXEL_PONY_ADDRESS = "0x2B4652Bd6149E407E3F57190E25cdBa1FC9d37d8";
        const BASE_MAINNET_CHAIN_ID = 8453;

        const PIXEL_PONY_ABI = [
            "event RaceExecuted(uint256 indexed raceId, address indexed player, uint256 horseId, uint256[3] winners, uint256 payout, bool won)",
            "function getGameStats() view returns (uint256 totalRacesCount, uint256 totalTicketsCount, uint256 jackpotAmount, uint256[4] memory jackpotNumbers)"
        ];

        let allRaces = [];
        let displayedRaces = 0;
        const RACES_PER_PAGE = 10;
        let currentViewingRace = null;
        let animationInterval = null;
        let provider = null;
        let contract = null;

        // Load all races from blockchain
        async function loadAllRaces() {
            try {
                console.log('Loading all races from blockchain...');

                // Multiple RPC endpoints for fallback
                const rpcEndpoints = [
                    'https://base.gateway.tenderly.co',
                    'https://base-mainnet.public.blastapi.io',
                    'https://base.llamarpc.com',
                    'https://mainnet.base.org'
                ];

                let lastError = null;

                // Try each RPC endpoint
                for (const rpc of rpcEndpoints) {
                    try {
                        console.log(`Trying RPC: ${rpc}`);
                        provider = new ethers.providers.JsonRpcProvider(rpc);

                        // Test the connection
                        await provider.getBlockNumber();
                        console.log(`Connected to ${rpc}`);
                        break;
                    } catch (error) {
                        console.log(`Failed to connect to ${rpc}:`, error.message);
                        lastError = error;
                        continue;
                    }
                }

                if (!provider) {
                    throw new Error(`All RPC endpoints failed. Last error: ${lastError.message}`);
                }

                contract = new ethers.Contract(PIXEL_PONY_ADDRESS, PIXEL_PONY_ABI, provider);

                // Get current block number
                const currentBlock = await provider.getBlockNumber();
                console.log(`Current block: ${currentBlock}`);

                // Query last 100,000 blocks (about 3-4 weeks on Base)
                const fromBlock = Math.max(0, currentBlock - 100000);
                console.log(`Querying from block ${fromBlock} to ${currentBlock}`);

                // Query RaceExecuted events
                const filter = contract.filters.RaceExecuted();
                const events = await contract.queryFilter(filter, fromBlock, 'latest');

                console.log(`Found ${events.length} races`);

                // Parse all races
                allRaces = events.map(event => {
                    const args = event.args;
                    return {
                        raceId: args.raceId.toString(),
                        player: args.player,
                        playerHorseId: args.horseId.toNumber(),
                        winners: [
                            args.winners[0].toNumber(),
                            args.winners[1].toNumber(),
                            args.winners[2].toNumber()
                        ],
                        payout: ethers.utils.formatEther(args.payout), // 18 decimals for PONY
                        won: args.won,
                        blockNumber: event.blockNumber
                    };
                });

                // Sort by race ID descending (most recent first)
                allRaces.sort((a, b) => parseInt(b.raceId) - parseInt(a.raceId));

                console.log('Races loaded:', allRaces);
                return allRaces;
            } catch (error) {
                console.error('Error loading races:', error);
                throw error;
            }
        }

        // Display statistics
        async function displayStats() {
            try {
                // Query contract for total races and jackpot
                const gameStats = await contract.getGameStats();
                const totalRacesCount = gameStats.totalRacesCount.toString();
                const jackpotAmount = ethers.utils.formatEther(gameStats.jackpotAmount); // 18 decimals for PONY

                // Calculate unique players from loaded races
                const uniquePlayers = new Set(allRaces.map(r => r.player.toLowerCase())).size;

                document.getElementById('totalRaces').textContent = parseInt(totalRacesCount).toLocaleString();
                document.getElementById('totalPlayers').textContent = uniquePlayers.toLocaleString();
                document.getElementById('totalPrizes').textContent = formatPonyAmount(parseFloat(jackpotAmount));

                document.getElementById('statsSection').style.display = 'block';
            } catch (error) {
                console.error('Error displaying stats:', error);
                // Fallback to showing just loaded race count
                const uniquePlayers = new Set(allRaces.map(r => r.player.toLowerCase())).size;
                document.getElementById('totalRaces').textContent = allRaces.length.toLocaleString();
                document.getElementById('totalPlayers').textContent = uniquePlayers.toLocaleString();
                document.getElementById('totalPrizes').textContent = 'N/A';
                document.getElementById('statsSection').style.display = 'block';
            }
        }

        // Display races
        function displayRaces(append = false) {
            const container = document.getElementById('raceList');

            if (!append) {
                container.innerHTML = '';
                displayedRaces = 0;
            }

            const racesToShow = allRaces.slice(displayedRaces, displayedRaces + RACES_PER_PAGE);

            racesToShow.forEach(race => {
                const raceItem = document.createElement('div');
                raceItem.className = 'race-item';

                const betAmount = race.won ? parseFloat(race.payout) / 10 : parseFloat(race.payout);
                const winnersText = race.winners.map(w => `#${w + 1}`).join(', ');

                raceItem.innerHTML = `
                    <div class="race-header">
                        <div class="race-id">Race #${race.raceId}</div>
                        <div class="race-status ${race.won ? 'won' : 'lost'}">
                            ${race.won ? '‚úì WON' : '‚úó LOST'}
                        </div>
                    </div>
                    <div class="race-details">
                        <p><strong>Player:</strong> ${race.player.slice(0, 6)}...${race.player.slice(-4)}</p>
                        <p><strong>Bet on Pony:</strong> #${race.playerHorseId + 1}</p>
                        <p><strong>Winners:</strong> Ponies ${winnersText}</p>
                        <p><strong>Bet Amount:</strong> ${formatPonyAmount(betAmount)} PONY</p>
                        ${race.won ? `<p><strong>Payout:</strong> ${formatPonyAmount(parseFloat(race.payout))} PONY</p>` : ''}
                        <div style="margin-top: 12px;">
                            <button onclick="viewRaceAnimation(${allRaces.indexOf(race)})" style="font-size: 7px; padding: 4px 8px; margin-right: 8px;">üé¨ Watch Replay</button>
                            <a href="https://basescan.org/tx/${race.blockNumber}" target="_blank" onclick="event.stopPropagation();">
                                <button style="font-size: 7px; padding: 4px 8px;">üìä Basescan</button>
                            </a>
                        </div>
                    </div>
                `;

                container.appendChild(raceItem);
            });

            displayedRaces += racesToShow.length;

            // Show/hide load more button
            console.log(`Displayed: ${displayedRaces}, Total: ${allRaces.length}`);
            const loadMoreBtn = document.getElementById('loadMoreSection');
            if (displayedRaces < allRaces.length) {
                console.log('Showing Load More button');
                loadMoreBtn.style.display = 'block';
            } else {
                console.log('Hiding Load More button');
                loadMoreBtn.style.display = 'none';
            }

            document.getElementById('raceListSection').style.display = 'block';
        }

        // Load more races
        function loadMoreRaces() {
            displayRaces(true);
        }

        // View race animation
        function viewRaceAnimation(raceIndex) {
            currentViewingRace = allRaces[raceIndex];

            // Hide list, show animation
            document.getElementById('raceListSection').style.display = 'none';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('animationSection').style.display = 'block';
            document.getElementById('animationTitle').textContent = `üèÅ Race #${currentViewingRace.raceId} Replay`;

            // Create and animate race
            createRaceTrack();
            animateRace();

            // Scroll to animation
            document.getElementById('animationSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Back to list
        function backToList() {
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            currentViewingRace = null;
            document.getElementById('animationSection').style.display = 'none';
            document.getElementById('raceListSection').style.display = 'block';
            document.getElementById('statsSection').style.display = 'block';
        }

        // Create race track
        function createRaceTrack() {
            const container = document.getElementById('raceLanes');
            container.innerHTML = '';

            for (let i = 0; i < 16; i++) {
                const lane = document.createElement('div');
                lane.className = 'track-lane';

                const spriteNum = (i % 30) + 1;
                const isPlayerHorse = i === currentViewingRace.playerHorseId;

                lane.innerHTML = `
                    <span class="lane-number">#${i + 1}</span>
                    <img src="sprites/${spriteNum}.png" alt="Pony ${i + 1}"
                         class="horse-racer ${isPlayerHorse ? 'player-horse' : ''}"
                         id="horse-${i}">
                `;
                container.appendChild(lane);
            }
        }

        // Animate race
        function animateRace() {
            const trackWidth = document.getElementById('trackContainer').offsetWidth - 100;
            const duration = 5000; // 5 seconds
            const fps = 60;
            const frames = (duration / 1000) * fps;

            // Generate random positions for each horse
            const positions = [];
            for (let i = 0; i < 16; i++) {
                positions[i] = [];
                let currentPos = 0;
                for (let frame = 0; frame < frames; frame++) {
                    const progress = Math.random() * 3;
                    currentPos += progress;
                    positions[i][frame] = Math.min(currentPos, trackWidth);
                }
            }

            // Adjust winners to finish first based on their place
            currentViewingRace.winners.forEach((winnerId, place) => {
                const finishFrame = frames - (place * 30); // 1st finishes first, then 2nd, then 3rd
                for (let frame = 0; frame < frames; frame++) {
                    const progress = frame / finishFrame;
                    positions[winnerId][frame] = trackWidth * Math.min(progress, 1);
                }
            });

            // Normalize other horses to finish after winners
            for (let i = 0; i < 16; i++) {
                if (!currentViewingRace.winners.includes(i)) {
                    const finishFrame = frames + (Math.random() * 50);
                    for (let frame = 0; frame < frames; frame++) {
                        positions[i][frame] = (positions[i][frame] / positions[i][frames - 1]) * trackWidth * (frame / finishFrame);
                        positions[i][frame] = Math.min(positions[i][frame], trackWidth * 0.95);
                    }
                }
            }

            let frame = 0;
            if (animationInterval) {
                clearInterval(animationInterval);
            }

            animationInterval = setInterval(() => {
                for (let i = 0; i < 16; i++) {
                    const horse = document.getElementById(`horse-${i}`);
                    if (horse) {
                        horse.style.left = positions[i][frame] + 'px';

                        // Add winner animation when they cross finish line
                        if (positions[i][frame] >= trackWidth - 50 && currentViewingRace.winners.includes(i)) {
                            horse.classList.add('winner');
                        }
                    }
                }

                frame++;
                if (frame >= frames) {
                    clearInterval(animationInterval);
                }
            }, 1000 / fps);
        }

        // Replay animation
        function replayAnimation() {
            // Reset all horses
            for (let i = 0; i < 16; i++) {
                const horse = document.getElementById(`horse-${i}`);
                if (horse) {
                    horse.style.left = '30px';
                    horse.classList.remove('winner');
                }
            }

            // Restart animation
            setTimeout(() => {
                animateRace();
            }, 100);
        }

        // Share race on Twitter
        function shareOnTwitter() {
            const text = `Just watched an epic race on Pixel Ponies! üèá Play now at pxpony.com`;
            const twitterUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(twitterUrl, '_blank', 'width=550,height=420');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadAllRaces();

                if (allRaces.length === 0) {
                    document.getElementById('loadingSection').innerHTML = '<p>No races found yet. Be the first to race!</p>';
                    return;
                }

                displayStats();
                displayRaces();

                document.getElementById('loadingSection').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingSection').innerHTML = `<p style="color: red;">Error loading races: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
